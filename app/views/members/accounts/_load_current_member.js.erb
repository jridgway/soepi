<script type="text/javascript">
  $(document).ready(function () {
    <% if current_member %>
      current_member = {
          authenticated: true,
          id: <%= current_member.id %>,
          name: '<%= current_member.name %>',
          nickname: '<%= current_member.nickname %>',
          nickname_linked: '<%= link_to current_member.nickname, main_app.member_path(current_member) %>',
          pic: '<%= escape_javascript avatar(current_member) %>',
          unseen_messages_count: '<%= Message.involving_member_unseen(current_member.id).count %>'
        }
    <% else %>
      current_member = {
          authenticated: false,
          id: -1,
          name: 'Visitor',
          nickname: '',
          nickname_linked: '',
          pic: '',
          unseen_messages_count: '0'
        }
    <% end %>
    show_hide_member_related();  
    $('.state-not-pending[data-state="pending"]').hide();
    $('.state-not-drafting[data-state="drafting"]').hide();
    $('.state-not-review-requested[data-state="review_requested"]').hide();
    $('.state-not-launched[data-state="launched"]').hide();
    $('.state-not-closed[data-state="closed"]').hide();
    $('.state-not-published[data-state="published"]').hide();
    init_sign_in_links();
    select_details_menu_item();
    $('.current-member-name').html(current_member['name']);
    $('.current-member-nickname').html(current_member['nickname']);
    $('.current-member-nickname-linked').html(current_member['nickname_linked']);
    $('.current-member-pic').html(current_member['pic']);
    $('.current-member-unseen-messages-count').html(current_member['unseen_messages_count']);
    $('body').append("<%= escape_javascript(render(:partial => '/members/accounts/flash')) %>");
    $('#alert').dialog({modal:true, zIndex:9, minWidth:400}).show('blind');
    if($('#more-details').find(':visible').length == 0) {
      $('#more-details').hide();
    }
  });
  
  <% if current_member %> 
    function show_hide_member_related() {
      set_followable_toggle();
      $('.members-only').show();
      $('.visitors-only').hide();
      $('.owner-only[data-member-id=<%= current_member.id %>]').show();
      $('.owner-only-until-published[data-member-id=<%= current_member.id %>]').show();
      $('.owner-only-not-admins[data-member-id=<%= current_member.id %>]').show();
      $('.not-owner[data-member-id=<%= current_member.id %>]').hide();
      $('.not-owner[data-member-id!=<%= current_member.id %>]').show(); 
      $('.owner-only-until-published[data-state=published], .owner-only-until-published[data-state=closed]').show(); 
      <% if current_member.admin? %>
        $('.owner-only').show();
        $('.owner-only-not-admins[data-member-id!=<%= current_member.id %>]').hide();
        $('.owner-only-until-published').show(); 
        $('.admins-only').show();
        $('.not-admin').hide();
      <% end %> 
    }
     
    function set_followable_toggle() {
      <% if @followable and current_member.following?(@followable) %>
        $('#follow-toggle').find('span').text('Unfollow');
      <% else %>
        $('#follow-toggle').find('span').text('Follow');
      <% end %>
    }
  <% else %>
    function show_hide_member_related() {
      $('.members-only').hide();
      $('.visitors-only').show();
      $('.owner-only').hide();
      $('.not-owner').show();
      restrict_to_members();
      $('.admins-only').hide();
      $('.not-admin').show();
    }
    
    $('#follow-toggle').show();
      
    function restrict_to_members() {
      $('.restrict-to-members').unbind('click');
      $('.restrict-to-members').click(function(e) {
        e.preventDefault();
        if($(this).attr('data-method') == null || $(this).attr('data-method') == 'get') {
          sign_in_dialog($(this).attr('href'));
        } else {
          sign_in_dialog();
        }
        return false;
      });
    }
  <% end %>
  
  function select_details_menu_item() {
    var relative = jQuery.url.attr('relative').replace(/\?.*/, '').replace(/#.*/, '').replace(/\/+$/, '');
    var available_items = 0;
    if(controller_name == 'pages' || controller_name == 'welcome' || controller_name == 'inquiries') {
      $('#details').show();
      return;
    }
    $('#details ul.menu li').each(function(index, value) {
      if($(this).css('display') != 'none') {
        available_items += 1;
      }
    });
    if(available_items == 0) {
      $('#details').hide();
    } else {
      $('#details').show();
      $('#details ul.menu li a').each(function() {
        if($(this).attr('href') == relative || $(this).attr('href') == unescape(relative)) {
          $(this).addClass('active');
        }
      });
    }
  }
</script>
